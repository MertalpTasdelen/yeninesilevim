{% load static %}
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}My Inventory App{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.1/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid" style="max-width: 1400px; margin: 0 auto;">
            <a class="navbar-brand" href="{% url 'product_list' %}">INVENTORY</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"
                    style="border: 1px solid var(--color-border);">
                <span class="navbar-toggler-icon" style="filter: invert(1);"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'product_list' %}">Ä°lanlar</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'purchase_items_list' %}">ÃœrÃ¼nler</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if not request.session.is_logged_in %}disabled{% endif %}" 
                           href="{% url 'add_product' %}">ÃœrÃ¼n Ekle</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'profit_calculator' %}">KÃ¢r Hesaplama</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'profit_calculator_list' %}">KÃ¢r KayÄ±tlarÄ±</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if not request.session.is_logged_in %}disabled{% endif %}" 
                           href="{% url 'trendyol_profit' %}">Trendyol</a>
                    </li>
                    <li class="nav-item">
                        {% if request.session.is_logged_in %}
                        <form method="POST" action="{% url 'logout' %}" style="display: inline;">
                            {% csrf_token %}
                            <button class="nav-link" type="submit" 
                                    style="background: none; border: none; cursor: pointer; padding: 0.5rem 1rem;">
                                <i class="bi bi-box-arrow-right"></i> Ã‡Ä±kÄ±ÅŸ
                            </button>
                        </form>
                        {% else %}
                        <a class="nav-link" href="{% url 'login' %}">GiriÅŸ</a>
                        {% endif %}
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Content Area -->
    {% block content %}
    {% endblock %}

    <!-- Footer -->
    <footer>
        <div style="max-width: 1400px; margin: 0 auto; text-align: center;">
            <p style="margin: 0;">&copy; 2024 Inventory Manager</p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Service worker kaydÄ± -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register("/service-worker.js")
                    .then(function (registration) {
                        console.log('ServiceWorker registered with scope:', registration.scope);
                    })
                    .catch(function (error) {
                        console.error('ServiceWorker registration failed:', error);
                    });
            });
        }

        // âœ… CSRF Token Helper
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // âœ… VAPID Key Base64 -> Uint8Array DÃ¶nÃ¼ÅŸÃ¼mÃ¼
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // âœ… Push Notification Subscription Fonksiyonu
        window.subscribeToPush = function() {
            console.log('ðŸš€ subscribeToPush() Ã§aÄŸrÄ±ldÄ±!');
            
            // Notification API kontrolÃ¼
            if (!('Notification' in window)) {
                console.error('âŒ Notification API desteklenmiyor');
                alert('âŒ TarayÄ±cÄ±nÄ±z bildirim desteÄŸi sunmuyor.');
                return Promise.reject('Notification API desteklenmiyor');
            }
            
            if (!('serviceWorker' in navigator)) {
                console.error('âŒ Service Worker desteklenmiyor');
                alert('âŒ TarayÄ±cÄ±nÄ±z bildirim desteÄŸi sunmuyor.');
                return Promise.reject('Service Worker desteklenmiyor');
            }
            
            if (!('PushManager' in window)) {
                console.error('âŒ Push API desteklenmiyor');
                alert('âŒ TarayÄ±cÄ±nÄ±z push bildirimleri desteklemiyor.');
                return Promise.reject('Push API desteklenmiyor');
            }

            console.log('âœ… TÃ¼m API\'ler destekleniyor, Service Worker hazÄ±r olmasÄ± bekleniyor...');

            return navigator.serviceWorker.ready.then(function(registration) {
                console.log('âœ… Service Worker hazÄ±r:', registration);
                
                const vapidPublicKey = "{{ VAPID_PUBLIC_KEY }}";
                console.log('VAPID Key:', vapidPublicKey ? 'Mevcut âœ…' : 'YOK âŒ');
                
                if (!vapidPublicKey) {
                    console.error('VAPID public key bulunamadÄ±!');
                    alert('Sunucu yapÄ±landÄ±rma hatasÄ±.');
                    return Promise.reject('VAPID key yok');
                }

                console.log('Bildirim izni isteniyor...');

                return Notification.requestPermission().then(function(permission) {
                    console.log('Ä°zin durumu:', permission);
                    
                    if (permission !== 'granted') {
                        console.warn('Bildirim izni reddedildi veya verilmedi');
                        alert('Bildirim izni reddedildi!');
                        return Promise.reject('Ä°zin reddedildi');
                    }

                    console.log('Ä°zin verildi, mevcut subscription kontrol ediliyor...');

                    // Ã–nce mevcut subscription'Ä± kontrol et
                    return registration.pushManager.getSubscription().then(function(existingSubscription) {
                        if (existingSubscription) {
                            console.log('âš ï¸ Eski subscription bulundu, siliniyor...', existingSubscription);
                            // Eski subscription'Ä± sil
                            return existingSubscription.unsubscribe().then(function() {
                                console.log('âœ… Eski subscription silindi, yeni subscription oluÅŸturuluyor...');
                                // Yeni subscription oluÅŸtur
                                return registration.pushManager.subscribe({
                                    userVisibleOnly: true,
                                    applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
                                });
                            });
                        } else {
                            console.log('Yeni subscription oluÅŸturuluyor...');
                            return registration.pushManager.subscribe({
                                userVisibleOnly: true,
                                applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
                            });
                        }
                    });
                });
            }).then(function(subscription) {
                console.log('ðŸ“¤ Subscription oluÅŸturuldu:', subscription);
                
                // Subscription verisini hazÄ±rla - Django-webpush'un beklediÄŸi formatta
                const jsonSubscription = subscription.toJSON();
                
                // FormData kullanarak gÃ¶nder - group parametresi ile
                const formData = new FormData();
                formData.append('status_type', 'subscribe');
                formData.append('endpoint', jsonSubscription.endpoint);
                formData.append('p256dh', jsonSubscription.keys.p256dh);
                formData.append('auth', jsonSubscription.keys.auth);
                formData.append('group', 'low_stock');

                console.log('ðŸ“¤ Form data hazÄ±rlandÄ±');
                console.log('Endpoint:', jsonSubscription.endpoint);
                console.log('P256DH:', jsonSubscription.keys.p256dh);
                console.log('Auth:', jsonSubscription.keys.auth);
                console.log('Group: low_stock');

                return fetch('/api/push-subscribe', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });
            }).then(function(response) {
                console.log('ðŸ“¥ Sunucu cevabÄ±:', response.status, response.statusText);
                
                if (response.ok) {
                    alert('âœ… Stok uyarÄ±larÄ± baÅŸarÄ±yla aktif edildi!');
                    console.log('âœ… Subscription sunucuya kaydedildi');
                    return response.json();
                } else {
                    console.error('âŒ Sunucu hatasÄ±:', response.status);
                    return response.text().then(function(text) {
                        console.error('âŒ Hata detayÄ±:', text);
                        alert('âŒ KayÄ±t baÅŸarÄ±sÄ±z oldu. LÃ¼tfen tekrar deneyin.');
                        throw new Error('Subscription kaydetme baÅŸarÄ±sÄ±z: ' + response.status);
                    });
                }
            }).catch(function(error) {
                console.error('âŒ Push subscription hatasÄ±:', error);
                alert('âŒ Bir hata oluÅŸtu: ' + error.message);
            });
        };
    </script>
