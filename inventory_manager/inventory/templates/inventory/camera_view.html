{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5 text-center">
    <h2 class="mb-4 fw-bold">ðŸ“· Barkod TarayÄ±cÄ±</h2>

    <div class="alert alert-info" role="alert" id="statusMessage">
        Kameraya eriÅŸim izni vermeniz gerekiyor.
    </div>

    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">
            <div id="barcode-reader" style="width: 100%; height: 60vh; border: 3px solid #ccc;
            border-radius: 12px; overflow: hidden;">
            </div>
        </div>
    </div>

    <div class="mt-4">
        <button id="retryButton" class="btn btn-outline-secondary d-none">ðŸ”„ Yeniden Dene</button>
        <button id="closeButton" class="btn btn-danger">Kapat</button>
    </div>
</div>
<style>
  #barcode-reader {
      width: 100%;
      height: 60vh; /* ekranÄ±n %60â€™Ä±nÄ± kaplar */
      border: 3px solid #ccc;
      border-radius: 12px;
      overflow: hidden;
  }

  #barcode-reader video {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover;
  }
</style>

<!-- QuaggaJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js" defer></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const statusMsg = document.getElementById("statusMessage");
        const retryBtn = document.getElementById("retryButton");
        const closeBtn = document.getElementById("closeButton");

        // URL parametresinden hedef field'Ä± al (Ã¶rneÄŸin ?field=purchase_barcode)
        const urlParams = new URLSearchParams(window.location.search);
        const targetField = urlParams.get("field") || "product_search";

        /**
         * Durum mesajÄ±nÄ± gÃ¼ncelle.  Tip parametresi, Bootstrap'in
         * alert-* sÄ±nÄ±flarÄ±nÄ± kullanarak mesajÄ±n stilini belirler.
         */
        function updateStatus(message, type = "info") {
            statusMsg.className = `alert alert-${type}`;
            statusMsg.textContent = message;
        }

        /**
         * Tarama sonucunu Ã¼st pencereye veya localStorage'a gÃ¶nderir ve
         * kamerayÄ± durdurur.  SonrasÄ±nda 1.5 saniye bekleyerek pencereyi
         * kapatÄ±r veya ana sayfaya dÃ¶ner.
         */
        function handleScanResult(code) {
            const payload = { type: "barcode_scanned", value: code, field: targetField };
            let delivered = false;

            if (window.opener && !window.opener.closed) {
                try {
                    window.opener.postMessage(payload, "*");
                    delivered = true;
                } catch (e) {
                    console.error("Mesaj gÃ¶nderilemedi:", e);
                }
            }

            if (!delivered) {
                try {
                    localStorage.setItem("last_scanned_barcode", JSON.stringify(payload));
                } catch (storageError) {
                    console.error("Barkod localStorage'a yazÄ±lamadÄ±:", storageError);
                }
            }

            // Stop Quagga and close/navigate immediately without timeout
            Quagga.stop();
            if (window.opener && !window.opener.closed) {
                window.close();
            } else {
                if (window.history.length > 1) {
                    window.history.back();
                } else {
                    window.location.href = "{% url 'product_list' %}";
                }
            }
        }

        /**
         * QuaggaJS'i baÅŸlatÄ±r.  Kamera izinleri reddedilirse kullanÄ±cÄ±ya
         * hata mesajÄ± gÃ¶sterir ve yeniden dene butonunu gÃ¶rÃ¼nÃ¼r hale getirir.
         */
        function initScanner() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                updateStatus("Kamera eriÅŸimi tarayÄ±cÄ±nÄ±zda desteklenmiyor.", "danger");
                return;
            }

            updateStatus("Kamera baÅŸlatÄ±lÄ±yor...");

            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.getElementById("barcode-reader"),
                    constraints: {
                        facingMode: "environment",
                        width: { ideal: window.innerWidth },
                        height: { ideal: window.innerHeight }
                    }
                },
                decoder: {
                    readers: [
                        "ean_reader"
                    ]
                },
                locate: true,
                numOfWorkers: 2,
                frequency: 10,
                halfSample: false,
                locator: {
                    patchSize: "large",
                    halfSample: false
                },
            }, function (err) {
                if (err) {
                    console.error("Quagga init error:", err);
                    updateStatus("Kamera baÅŸlatÄ±lamadÄ±. LÃ¼tfen izin verdiÄŸinizden emin olun.", "danger");
                    retryBtn.classList.remove("d-none");
                    return;
                }
                updateStatus("Kamera aktif. Barkodu okutun...");
                Quagga.start();
            });

            // When a barcode is detected, handle the result once and ignore subsequent detections
            Quagga.onDetected(result => {
                const code = result?.codeResult?.code;
                if (code) {
                    // Remove further detection listeners to avoid multiple triggers
                    Quagga.offDetected();
                    handleScanResult(code);
                }
            });
        }

        retryBtn.addEventListener("click", () => {
            retryBtn.classList.add("d-none");
            initScanner();
        });

        closeBtn.addEventListener("click", () => {
            // Gracefully stop the camera and close or navigate away
            Quagga.stop();
            if (window.opener && !window.opener.closed) {
                window.close();
            } else {
                window.location.href = "{% url 'product_list' %}";
            }
        });

        // Initialize scanner on page load
        initScanner();
    });
</script>
{% endblock %}