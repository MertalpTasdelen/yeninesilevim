{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5 text-center">
    <h2 class="mb-4 fw-bold">ğŸ“· Barkod TarayÄ±cÄ±</h2>

    <div class="alert alert-info" role="alert" id="statusMessage">
        Kameraya eriÅŸim izni vermeniz gerekiyor.
    </div>

    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">
            <div id="barcode-reader">
                <video id="barcode-video" autoplay playsinline muted style="width: 100%; height: 100%;"></video>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <button id="retryButton" class="btn btn-outline-secondary d-none">ğŸ”„ Yeniden Dene</button>
        <button id="closeButton" class="btn btn-danger">Kapat</button>
    </div>
</div>
<style>
    #barcode-reader {
        width: 100%;
        height: 60vh;
        /* ekranÄ±n %60â€™Ä±nÄ± kaplar */
        border: 3px solid #ccc;
        border-radius: 12px;
        overflow: hidden;
    }

    #barcode-reader video {
        width: 100% !important;
        height: 100% !important;
        object-fit: cover;
    }
</style>

<!-- ZXing-js -->
<script type="module">
    import { BrowserMultiFormatReader } from 'https://cdn.jsdelivr.net/npm/@zxing/browser@latest/+esm';

    document.addEventListener("DOMContentLoaded", async () => {
        const statusMsg = document.getElementById("statusMessage");
        const retryBtn = document.getElementById("retryButton");
        const closeBtn = document.getElementById("closeButton");
        const videoElem = document.getElementById("barcode-video");
        let codeReader = null;

        const urlParams = new URLSearchParams(window.location.search);
        const targetField = urlParams.get("field") || "direct";

        function updateStatus(message, type = "info") {
            console.log("Status:", message); // Debug log
            statusMsg.className = `alert alert-${type}`;
            statusMsg.textContent = message;
        }

        function sendResultToParent(code) {
            console.log("Barkod okundu:", code);

            // Ana pencereye mesaj gÃ¶nder
            if (window.opener) {
                const payload = {
                    type: 'barcode_scanned',
                    field: 'product_search',
                    value: code
                };

                window.opener.postMessage(payload, '*');
                updateStatus(`Barkod okundu: ${code}`, "success");

                // KamerayÄ± kapat
                if (codeReader) {
                    codeReader.reset();
                }
                if (videoElem.srcObject) {
                    videoElem.srcObject.getTracks().forEach(track => track.stop());
                }

                // Pencereyi hemen kapat
                window.close();
            }
        }

        async function requestCameraAndStart() {
            updateStatus("Kamera izni isteniyor...");
            retryBtn.classList.add("d-none");

            try {
                codeReader = new BrowserMultiFormatReader();
                console.log("ZXing baÅŸlatÄ±ldÄ±"); // Debug log

                updateStatus("Kamera aktif. Barkodu okutun...");

                await codeReader.decodeFromVideoDevice(
                    null, // varsayÄ±lan kamera
                    'barcode-video',
                    (result, err) => {
                        if (result) {
                            console.log("Barkod tespit edildi:", result); // Debug log
                            const code = result.getText();
                            if (code) {
                                sendResultToParent(code);
                            }
                        }
                        if (err && !(err instanceof TypeError)) {
                            // Hata logla ama normal tarama hatalarÄ±nÄ± gÃ¶rmezden gel
                            console.error("Tarama hatasÄ±:", err);
                        }
                    }
                );
            } catch (err) {
                console.error("Kamera baÅŸlatma hatasÄ±:", err);
                handleCameraError(err);
            }
        }


        function handleCameraError(err) {
            // Permissions API ile durum kontrolÃ¼ (tÃ¼m tarayÄ±cÄ±lar desteklemez)
            if (navigator.permissions && navigator.permissions.query) {
                navigator.permissions.query({ name: 'camera' })
                    .then(p => {
                        if (p.state === 'denied') {
                            updateStatus("Kamera izni reddedildi. TarayÄ±cÄ± ayarlarÄ±ndan kamera eriÅŸimini aÃ§Ä±n.", "danger");
                            retryBtn.classList.remove("d-none");
                        } else if (p.state === 'prompt') {
                            updateStatus("TarayÄ±cÄ± izin penceresi gÃ¶rÃ¼ntÃ¼lenemedi. Yeniden deneyin.", "warning");
                            retryBtn.classList.remove("d-none");
                        } else {
                            updateStatus("Kamera baÅŸlatÄ±lamadÄ±. Cihazda kamera yok veya baÅŸka bir uygulama kullanÄ±yor olabilir.", "danger");
                            retryBtn.classList.remove("d-none");
                        }
                    }).catch(() => {
                        // Permissions API yoksa genel hata mesajÄ±
                        updateStatus("Kamera aÃ§Ä±lamadÄ± â€” lÃ¼tfen site ayarlarÄ±ndan kamerayÄ± kontrol edin ve https kullandÄ±ÄŸÄ±nÄ±zdan emin olun.", "danger");
                        retryBtn.classList.remove("d-none");
                    });
            } else {
                updateStatus("Kamera aÃ§Ä±lamadÄ± â€” lÃ¼tfen site ayarlarÄ±ndan kamerayÄ± kontrol edin ve https kullandÄ±ÄŸÄ±nÄ±zdan emin olun.", "danger");
                retryBtn.classList.remove("d-none");
            }
        }

        retryBtn.addEventListener("click", () => {
            retryBtn.classList.add("d-none");
            requestCameraAndStart();
        });

        closeBtn.addEventListener("click", () => {
            if (codeReader) {
                codeReader.reset();
            }
            if (videoElem.srcObject) {
                videoElem.srcObject.getTracks().forEach(t => t.stop());
            }
            window.close();
        });

        // Sayfa yÃ¼klendiÄŸinde Ã¶nce Permissions API ile durumu kontrol edip,
        // eÄŸer 'granted' ise yine de getUserMedia Ã§aÄŸÄ±rÄ±p stream baÅŸlatÄ±yoruz.
        (async () => {
            try {
                if (navigator.permissions && navigator.permissions.query) {
                    const p = await navigator.permissions.query({ name: 'camera' });
                    if (p.state === 'granted') {
                        // yine de aÃ§Ä±kÃ§a getUserMedia Ã§aÄŸÄ±r (tarayÄ±cÄ± prompt gÃ¶stermez ama izin var)
                        requestCameraAndStart();
                        return;
                    }
                    if (p.state === 'denied') {
                        updateStatus("Kamera izni tarayÄ±cÄ± tarafÄ±ndan reddedilmiÅŸ. LÃ¼tfen site ayarlarÄ±ndan kamerayÄ± aÃ§Ä±n.", "danger");
                        retryBtn.classList.remove("d-none");
                        return;
                    }
                }
            } catch (e) {
                // Permissions API yoksa devam edip getUserMedia ile prompt gÃ¶stereceÄŸiz
            }
            // Normal akÄ±ÅŸ - kullanÄ±cÄ±ya izin penceresini tetikle
            requestCameraAndStart();
        })();
    });
</script>

{% endblock %}