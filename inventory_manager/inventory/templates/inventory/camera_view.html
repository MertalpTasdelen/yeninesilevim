{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5 text-center">
    <h2 class="mb-4 fw-bold">ğŸ“· Barkod TarayÄ±cÄ±</h2>

    <div class="alert alert-info" role="alert" id="statusMessage">
        Kameraya eriÅŸim izni vermeniz gerekiyor.
    </div>

    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">
            <div id="barcode-reader" style="width: 100%; height: 60vh; border: 3px solid #ccc;
            border-radius: 12px; overflow: hidden;">
            </div>
        </div>
    </div>

    <div class="mt-4">
        <button id="retryButton" class="btn btn-outline-secondary d-none">ğŸ”„ Yeniden Dene</button>
        <button id="closeButton" class="btn btn-danger">Kapat</button>
    </div>
</div>

<style>
  #barcode-reader {
      width: 100%;
      height: 60vh;
      border: 3px solid #ccc;
      border-radius: 12px;
      overflow: hidden;
  }
  #barcode-reader video {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover;
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js" defer></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const statusMsg = document.getElementById("statusMessage");
    const retryBtn = document.getElementById("retryButton");
    const closeBtn = document.getElementById("closeButton");
    const urlParams = new URLSearchParams(window.location.search);
    const targetField = urlParams.get("field") || "product_search";

    function updateStatus(message, type = "info") {
        statusMsg.className = `alert alert-${type}`;
        statusMsg.textContent = message;
    }

    function handleScanResult(code) {
        updateStatus(`âœ… Barkod okundu: ${code}`, "success");
        const payload = { type: "barcode_scanned", value: code, field: targetField };
        try {
            localStorage.setItem("last_scanned_barcode", JSON.stringify(payload));
        } catch (err) {
            console.error("LocalStorage hatasÄ±:", err);
        }

        // Barkod okunduktan sonra kamerayÄ± kapat ve 1.5 saniye sonra geri dÃ¶n
        setTimeout(() => {
            if (window.opener && !window.opener.closed) {
                window.close();
            } else {
                window.history.back();
            }
        }, 1500);
    }

    function initScanner() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            updateStatus("Kamera eriÅŸimi desteklenmiyor.", "danger");
            return;
        }

        updateStatus("Kamera baÅŸlatÄ±lÄ±yor...");

        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.getElementById("barcode-reader"),
                constraints: { facingMode: "environment" }
            },
            decoder: { readers: ["ean_reader", "code_128_reader"] }
        }, function (err) {
            if (err) {
                console.error("Quagga init error:", err);
                updateStatus("Kamera baÅŸlatÄ±lamadÄ±.", "danger");
                retryBtn.classList.remove("d-none");
                return;
            }
            updateStatus("Kamera aktif. Barkodu okutun...");
            Quagga.start();
        });

        Quagga.onDetected(result => {
            const code = result?.codeResult?.code;
            if (code) {
                Quagga.stop();
                handleScanResult(code);
            }
        });
    }

    retryBtn.addEventListener("click", () => {
        retryBtn.classList.add("d-none");
        initScanner();
    });

    closeBtn.addEventListener("click", () => {
        Quagga.stop();
        window.close();
    });

    initScanner();
});
</script>
{% endblock %}