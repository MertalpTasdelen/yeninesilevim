{% extends 'base.html' %}

{% block title %}Barcode Scanner{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center">Barcode Scanner</h1>
    <div class="d-flex justify-content-center">
        <!-- Video container -->
        <div id="interactive" class="viewport w-100"></div>
    </div>
    <div id="result" class="mt-3 text-center text-success font-weight-bold"></div>
</div>

<!-- Include QuaggaJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<style>
    /* Ensure the video container is responsive */
    .viewport {
        position: relative;
        width: 100%;
        max-width: 480px;
        height: auto;
        overflow: hidden;
        border: 2px solid #ccc;
        border-radius: 10px;
    }

    video {
        width: 100%;
        height: auto;
        display: block;
        border-radius: 10px;
    }

    canvas {
        display: none; /* Hide the canvas element if not needed */
    }
</style>

<script>
    const resultDiv = document.getElementById('result');

    // Initialize Quagga
    Quagga.init(
        {
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector("#interactive"), // Video container
                constraints: {
                    facingMode: "environment" // Use rear-facing camera
                }
            },
            decoder: {
                readers: ["code_128_reader", "ean_reader", "upc_reader"], // Supported barcode formats
            }
        },
        function (err) {
            if (err) {
                console.error("QuaggaJS initialization failed:", err);
                alert("Failed to initialize barcode scanner. Please check your device and permissions.");
                return;
            }
            console.log("QuaggaJS initialized successfully.");
            Quagga.start();
        }
    );

    // Process barcodes
    Quagga.onDetected((data) => {
        console.log("Barcode detected:", data.codeResult.code);
        resultDiv.innerHTML = `Decoded Barcode: <br><strong>${data.codeResult.code}</strong>`;
        resultDiv.classList.add('text-success');

        // Stop the scanner after a successful scan
        Quagga.stop();
    });

    Quagga.onProcessed((result) => {
        if (result && result.codeResult) {
            console.log("Processing frame:", result.codeResult.code);
        }
    });
</script>
{% endblock %}