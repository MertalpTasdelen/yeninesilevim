{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fashion">
    <div class="page-header">
        <h1 class="page-title">Barkod Tarayıcı</h1>
    </div>

    <div class="alert alert-info" role="alert" id="statusMessage" style="text-align: center; margin-bottom: var(--spacing-lg);">
        Kameraya erişim izni vermeniz gerekiyor.
    </div>

    <div style="max-width: 800px; margin: 0 auto;">
        <div id="barcode-reader" style="width: 100%; height: 60vh; border: 2px solid var(--color-border); border-radius: 8px; overflow: hidden; background: var(--color-background);">
        </div>
    </div>

    <div style="text-align: center; margin-top: var(--spacing-lg);">
        <button id="retryButton" class="btn btn-secondary d-none" style="margin-right: var(--spacing-sm);">
            <i class="bi bi-arrow-clockwise"></i> Yeniden Dene
        </button>
        <button id="closeButton" class="btn btn-danger">Kapat</button>
    </div>
</div>

<style>
#barcode-reader video {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js" defer></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const statusMsg = document.getElementById("statusMessage");
    const retryBtn = document.getElementById("retryButton");
    const closeBtn = document.getElementById("closeButton");

    const urlParams = new URLSearchParams(window.location.search);
    const targetField = urlParams.get("field") || "product_search";

    function updateStatus(message, type = "info") {
        statusMsg.className = `alert alert-${type}`;
        statusMsg.textContent = message;
    }

    function handleScanResult(code) {
        const payload = { type: "barcode_scanned", value: code, field: targetField };
        let delivered = false;

        if (window.opener && !window.opener.closed) {
            try {
                window.opener.postMessage(payload, "*");
                delivered = true;
            } catch (e) {
                console.error("Mesaj gönderilemedi:", e);
            }
        }

        if (!delivered) {
            try {
                localStorage.setItem("last_scanned_barcode", JSON.stringify(payload));
            } catch (storageError) {
                console.error("Barkod localStorage'a yazılamadı:", storageError);
            }
        }

        Quagga.stop();
        if (window.opener && !window.opener.closed) {
            window.close();
        } else {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = "{% url 'product_list' %}";
            }
        }
    }

    function initScanner() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            updateStatus("Kamera erişimi tarayıcınızda desteklenmiyor.", "danger");
            return;
        }

        updateStatus("Kamera başlatılıyor...");

        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.getElementById("barcode-reader"),
                constraints: {
                    facingMode: "environment",
                    width: { ideal: window.innerWidth },
                    height: { ideal: window.innerHeight }
                }
            },
            decoder: {
                readers: ["ean_reader"]
            },
            locate: true,
            numOfWorkers: 2,
            frequency: 10,
            halfSample: false,
            locator: {
                patchSize: "large",
                halfSample: false
            },
        }, function (err) {
            if (err) {
                console.error("Quagga init error:", err);
                updateStatus("Kamera başlatılamadı. Lütfen izin verdiğinizden emin olun.", "danger");
                retryBtn.classList.remove("d-none");
                return;
            }
            updateStatus("Kamera aktif. Barkodu okutun...");
            Quagga.start();
        });

        Quagga.onDetected(result => {
            const code = result?.codeResult?.code;
            if (code) {
                Quagga.offDetected();
                handleScanResult(code);
            }
        });
    }

    retryBtn.addEventListener("click", () => {
        retryBtn.classList.add("d-none");
        initScanner();
    });

    closeBtn.addEventListener("click", () => {
        Quagga.stop();
        if (window.opener && !window.opener.closed) {
            window.close();
        } else {
            window.location.href = "{% url 'product_list' %}";
        }
    });

    initScanner();
});
</script>
{% endblock %}
