{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5 text-center">
    <h2 class="mb-4 fw-bold">ğŸ“· Barkod TarayÄ±cÄ±</h2>

    <div class="alert alert-info" role="alert" id="statusMessage">
        Kameraya eriÅŸim izni vermeniz gerekiyor.
    </div>

    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">
            <div id="barcode-reader"
                 style="width: 100%; aspect-ratio: 4 / 3; border: 3px solid #ccc; border-radius: 12px; overflow: hidden;">
            </div>
        </div>
    </div>

    <div class="mt-4">
        <button id="retryButton" class="btn btn-outline-secondary d-none">ğŸ”„ Yeniden Dene</button>
        <button id="closeButton" class="btn btn-danger">Kapat</button>
    </div>
</div>

<!-- QuaggaJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js" defer></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const statusMsg = document.getElementById("statusMessage");
    const retryBtn = document.getElementById("retryButton");
    const closeBtn = document.getElementById("closeButton");

    // URL parametresinden hedef field'Ä± al (Ã¶rneÄŸin ?field=purchase_barcode)
    const urlParams = new URLSearchParams(window.location.search);
    const targetField = urlParams.get("field") || "product_search";

    function updateStatus(message, type = "info") {
        statusMsg.className = `alert alert-${type}`;
        statusMsg.textContent = message;
    }

    function sendResultToParent(code) {
        const payload = { type: "barcode_scanned", value: code, field: targetField };
        let delivered = false;

        if (window.opener && !window.opener.closed) {
            try {
                window.opener.postMessage(payload, "*");
                delivered = true;
            } catch (e) {
                console.error("Mesaj gÃ¶nderilemedi:", e);
            }
        }

        if (!delivered) {
            try {
                localStorage.setItem("last_scanned_barcode", JSON.stringify(payload));
                updateStatus("Barkod okundu. ÃœrÃ¼n listesindeki arama kutusuna gÃ¶nderiliyor...", "success");
            } catch (storageError) {
                console.error("Barkod localStorage'a yazÄ±lamadÄ±:", storageError);
                updateStatus("Barkod okundu ama sonuÃ§ kaydedilemedi.", "warning");
            }
        } else {
            updateStatus(`Barkod okundu: ${code}`, "success");
        }

        // BirkaÃ§ saniye sonra otomatik kapanma
        setTimeout(() => {
            if (window.opener && !window.opener.closed) {
                window.close();
            } else {
                window.location.href = "{% url 'product_list' %}";
            }
        }, 1500);
    }

    function initScanner() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            updateStatus("Kamera eriÅŸimi tarayÄ±cÄ±nÄ±zda desteklenmiyor.", "danger");
            return;
        }

        updateStatus("Kamera baÅŸlatÄ±lÄ±yor...");

        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.getElementById("barcode-reader"),
                constraints: {
                    facingMode: "environment",
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            },
            decoder: {
                readers: [
                    "code_128_reader",
                    "ean_reader",
                    "ean_8_reader",
                    "code_39_reader",
                    "codabar_reader",
                    "upc_reader",
                    "upc_e_reader",
                    "i2of5_reader",
                    "2of5_reader",
                    "code_93_reader"
                ]
            },
            locate: true
        }, function (err) {
            if (err) {
                console.error("Quagga init error:", err);
                updateStatus("Kamera baÅŸlatÄ±lamadÄ±. LÃ¼tfen izin verdiÄŸinizden emin olun.", "danger");
                retryBtn.classList.remove("d-none");
                return;
            }
            updateStatus("Kamera aktif. Barkodu okutun...");
            Quagga.start();
        });

        Quagga.onDetected(result => {
            const code = result?.codeResult?.code;
            if (code) {
                Quagga.stop();
                updateStatus(`Barkod okundu: ${code}`, "success");
                sendResultToParent(code);
            }
        });
    }

    retryBtn.addEventListener("click", () => {
        retryBtn.classList.add("d-none");
        initScanner();
    });

    closeBtn.addEventListener("click", () => {
        Quagga.stop();
        window.close();
    });

    // Sayfa yÃ¼klenince tarayÄ±cÄ±yÄ± baÅŸlat
    initScanner();
});
</script>
{% endblock %}
