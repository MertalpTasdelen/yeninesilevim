{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">{{ form.instance.id|yesno:"√úr√ºn√º D√ºzenle,Yeni √úr√ºn Ekle" }}</h2>

    <form method="post">
        {% csrf_token %}
        <div class="mb-3">
            {{ form.name.label_tag }} {{ form.name }}
        </div>

        <div class="mb-3">
            {{ form.barcode.label_tag }} {{ form.barcode }}
        </div>

        <div class="mb-3">
            {{ form.purchase_barcode.label_tag }}
            <div class="input-group">
                {{ form.purchase_barcode }}
                <button type="button" id="openCamera" class="btn btn-outline-secondary">üì∑</button>
            </div>
        </div>

        <div class="mb-3">{{ form.purchase_price.label_tag }} {{ form.purchase_price }}</div>
        <div class="mb-3">{{ form.selling_price.label_tag }} {{ form.selling_price }}</div>
        <div class="mb-3">{{ form.commution.label_tag }} {{ form.commution }}</div>
        <div class="mb-3">{{ form.stock.label_tag }} {{ form.stock }}</div>
        <div class="mb-3">{{ form.image_url.label_tag }} {{ form.image_url }}</div>

        <button type="submit" class="btn btn-primary">Kaydet</button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const purchaseBarcodeInput = document.getElementById('id_purchase_barcode');
    const openCameraButton = document.getElementById('openCamera');

    function applyScannedBarcode(payload) {
        if (payload && payload.type === 'barcode_scanned' && payload.field === 'purchase_barcode') {
            purchaseBarcodeInput.value = payload.value;
        }
    }

    function consumeStoredBarcode() {
        const stored = localStorage.getItem('last_scanned_barcode');
        if (!stored) return;
        const parsed = JSON.parse(stored);
        applyScannedBarcode(parsed);
        localStorage.removeItem('last_scanned_barcode');
    }

    window.addEventListener('message', (e) => applyScannedBarcode(e.data));
    window.addEventListener('focus', consumeStoredBarcode);

    if (openCameraButton) {
        openCameraButton.addEventListener('click', () => {
            if (/Mobi|Android/i.test(navigator.userAgent)) {
                window.location.href = "{% url 'camera_view' %}?field=purchase_barcode";
            } else {
                window.open("{% url 'camera_view' %}?field=purchase_barcode", "_blank", "width=800,height=600");
            }
        });
    }

    consumeStoredBarcode();
});
</script>
{% endblock %}
