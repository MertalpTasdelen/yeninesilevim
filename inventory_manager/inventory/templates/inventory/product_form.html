{% extends 'base.html' %}

{% block content %}
<div class="container-fashion">
    <div class="page-header">
        <h1 class="page-title">{{ form.instance.id|yesno:"Ürünü Düzenle,Yeni Ürün Ekle" }}</h1>
    </div>

    <div class="form-container" style="max-width: 700px; margin: 0 auto;">
        <form method="post">
            {% csrf_token %}

            <div class="form-group">
                {{ form.name.label_tag }}
                {{ form.name }}
            </div>

            <div class="form-group">
                {{ form.barcode.label_tag }}
                {{ form.barcode }}
            </div>

            <div class="form-group">
                {{ form.purchase_barcode.label_tag }}
                <div class="input-group">
                    {{ form.purchase_barcode }}
                    <button type="button" id="openCamera" class="btn btn-outline-secondary">
                        <i class="bi bi-camera"></i>
                    </button>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    {{ form.purchase_price.label_tag }}
                    {{ form.purchase_price }}
                </div>

                <div class="form-group" style="flex: 1; margin-left: var(--spacing-md);">
                    {{ form.selling_price.label_tag }}
                    {{ form.selling_price }}
                </div>
            </div>

            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    {{ form.commution.label_tag }}
                    {{ form.commution }}
                </div>

                <div class="form-group" style="flex: 1; margin-left: var(--spacing-md);">
                    {{ form.stock.label_tag }}
                    {{ form.stock }}
                </div>
            </div>

            <div class="form-group">
                {{ form.image_url.label_tag }}
                {{ form.image_url }}
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Kaydet</button>
                <a href="{% url 'product_list' %}" class="btn btn-secondary">İptal</a>
                {% if form.instance.id %}
                <button type="button" class="btn btn-danger" onclick="deleteProduct()">Sil</button>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const purchaseBarcodeInput = document.getElementById('id_purchase_barcode');
    const openCameraButton = document.getElementById('openCamera');

    function handleBarcodeMessage(event) {
        if (event.data && event.data.type === 'barcode_scanned' && event.data.field === 'purchase_barcode') {
            purchaseBarcodeInput.value = event.data.value;
        }
    }

    function consumeStoredBarcode() {
        try {
            const storedPayload = localStorage.getItem('last_scanned_barcode');
            if (!storedPayload) return;
            const parsed = JSON.parse(storedPayload);
            if (parsed && parsed.field === 'purchase_barcode') {
                purchaseBarcodeInput.value = parsed.value;
                localStorage.removeItem('last_scanned_barcode');
            }
        } catch (error) {
            console.error('Kaydedilen barkod okunamadı:', error);
        }
    }

    if (openCameraButton) {
        openCameraButton.addEventListener('click', () => {
            const cameraUrl = "{% url 'camera_view' %}?field=purchase_barcode";
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            if (isMobile) {
                window.location.href = cameraUrl;
            } else {
                window.open(cameraUrl, "_blank", "width=800,height=600");
            }
        });
    }

    window.addEventListener('message', handleBarcodeMessage);
    window.addEventListener('storage', (event) => {
        if (event.key === 'last_scanned_barcode') {
            consumeStoredBarcode();
        }
    });
    window.addEventListener('focus', consumeStoredBarcode);
    consumeStoredBarcode();
});

{% if form.instance.id %}
function deleteProduct() {
    if (!confirm('Bu ürünü silmek istediğinize emin misiniz?')) return;
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = "{% url 'delete_product' form.instance.id %}";
    
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = '{{ csrf_token }}';
    form.appendChild(csrfInput);
    
    document.body.appendChild(form);
    form.submit();
}
{% endif %}
</script>
{% endblock %}
