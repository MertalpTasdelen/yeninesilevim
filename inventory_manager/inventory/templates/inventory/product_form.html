{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">{{ form.instance.id|yesno:"√úr√ºn√º D√ºzenle,Yeni √úr√ºn Ekle" }}</h2>

    <form method="post">
        {% csrf_token %}

        <div class="mb-3">
            {{ form.name.label_tag }}
            {{ form.name }}
        </div>

        <div class="mb-3">
            {{ form.barcode.label_tag }}
            {{ form.barcode }}
        </div>

        <!-- ‚úÖ Alƒ±≈ü Barkodu √∂zel alan -->
        <div class="mb-3">
            {{ form.purchase_barcode.label_tag }}
            <div class="input-group">
                {{ form.purchase_barcode }}
                <button type="button" id="openCamera" class="btn btn-outline-secondary">
                    üì∑
                </button>
            </div>
        </div>

        <div class="mb-3">
            {{ form.purchase_price.label_tag }}
            {{ form.purchase_price }}
        </div>

        <div class="mb-3">
            {{ form.selling_price.label_tag }}
            {{ form.selling_price }}
        </div>

        <div class="mb-3">
            {{ form.commution.label_tag }}
            {{ form.commution }}
        </div>

        <div class="mb-3">
            {{ form.stock.label_tag }}
            {{ form.stock }}
        </div>

        <div class="mb-3">
            {{ form.image_url.label_tag }}
            {{ form.image_url }}
        </div>

        <button type="submit" class="btn btn-primary">Kaydet</button>
    </form>
    {% if form.instance.id %}
    <hr>
    <form method="post" action="{% url 'delete_product' form.instance.id %}" onsubmit="return confirm('Bu √ºr√ºn√º silmek istediƒüinize emin misiniz?');">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger">Sil</button>
    </form>
    {% endif %}
</div>

<!-- ‚úÖ Kamera entegrasyonu -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const purchaseBarcodeInput = document.getElementById('id_purchase_barcode');
    const openCameraButton = document.getElementById('openCamera');

    function handleBarcodeMessage(event) {
        if (event.data && event.data.type === 'barcode_scanned' && event.data.field === 'purchase_barcode') {
            purchaseBarcodeInput.value = event.data.value;
        }
    }

    // Consume a stored barcode from localStorage if it was saved by the scanner
    function consumeStoredBarcode() {
        try {
            const storedPayload = localStorage.getItem('last_scanned_barcode');
            if (!storedPayload) {
                return;
            }
            const parsed = JSON.parse(storedPayload);
            if (parsed && parsed.field === 'purchase_barcode') {
                purchaseBarcodeInput.value = parsed.value;
                localStorage.removeItem('last_scanned_barcode');
            }
        } catch (error) {
            console.error('Kaydedilen barkod okunamadƒ±:', error);
        }
    }

    if (openCameraButton) {
        openCameraButton.addEventListener('click', () => {
            const cameraUrl = "{% url 'camera_view' %}?field=purchase_barcode";
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            if (isMobile) {
                // Navigate in same tab on mobile to work around pop-up blockers
                window.location.href = cameraUrl;
            } else {
                window.open(cameraUrl, "_blank", "width=800,height=600");
            }
        });
    }

    // Listen for postMessage events from the scanner window
    window.addEventListener('message', handleBarcodeMessage);
    // Listen for localStorage events for cross-tab communication
    window.addEventListener('storage', (event) => {
        if (event.key === 'last_scanned_barcode') {
            consumeStoredBarcode();
        }
    });
    // When returning focus, consume any stored barcode
    window.addEventListener('focus', consumeStoredBarcode);
    // Immediately consume stored barcode on page load
    consumeStoredBarcode();
});
</script>
{% endblock %}