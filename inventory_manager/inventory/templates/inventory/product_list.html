{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">Ürün Listesi</h2>
    <form method="GET" action="{% url 'product_list' %}" class="mb-4">
        <div class="input-group mb-3">
            <input type="text" id="search-input" name="q" class="form-control"
                placeholder="Ürün adı, barkod veya alış barkodu ile ara..." value="{{ query|default_if_none:'' }}">
            <button type="button" class="btn btn-outline-secondary" id="openSearchCamera">
                <i class="bi bi-camera"></i>
            </button>
        </div>
    </form>

    <div id="product-list" class="row">
        {% include 'inventory/product_list_results.html' %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('search-input');
    const cameraButton = document.getElementById('openSearchCamera');

    function applyScannedBarcode(value) {
        if (!searchInput) return;
        searchInput.value = value;
        searchInput.dispatchEvent(new Event('input', { bubbles: true }));
    }

    function handleBarcodePayload(payload) {
        if (payload && payload.type === 'barcode_scanned' && payload.field === 'product_search') {
            applyScannedBarcode(payload.value);
        }
    }

    function consumeStoredBarcode() {
        const stored = localStorage.getItem('last_scanned_barcode');
        if (!stored) return;
        const parsed = JSON.parse(stored);
        handleBarcodePayload(parsed);
        localStorage.removeItem('last_scanned_barcode');
    }

    window.addEventListener('message', (e) => handleBarcodePayload(e.data));
    window.addEventListener('focus', consumeStoredBarcode);

    if (cameraButton) {
        cameraButton.addEventListener('click', () => {
            if (/Mobi|Android/i.test(navigator.userAgent)) {
                window.location.href = "{% url 'camera_view' %}?field=product_search";
            } else {
                window.open("{% url 'camera_view' %}?field=product_search", "_blank", "width=800,height=600");
            }
        });
    }

    consumeStoredBarcode();
});
</script>
{% endblock %}